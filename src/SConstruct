import os
import sys
from SCons.Script import *

platform = ARGUMENTS.get("platform", sys.platform)
build_type = ARGUMENTS.get("build", "debug")

godot_cpp_path = "../godot-cpp"
libuiohook_path = "../libuiohook"
libuiohook_path_linux = "../libuiohookLinux"
libuiohook_path_macos = "../libuiohookMac"

sources = [
    "GlobalInput.cpp",
    "register_types.cpp",
    "GlobalInputUiohook.cpp",
    "GlobalInputWindows.cpp",
    "GlobalInputsx11.cpp"

]

def fixpath(p):
    return os.path.abspath(p).replace("\\", "/")

host_platform = sys.platform.lower()
is_wsl = "microsoft" in os.uname().release.lower() if hasattr(os, "uname") else False
output_dir = ""

if platform.startswith("win"):
    if host_platform.startswith("win"):
        cxx = "g++"
        cc = "gcc"
    else:
        cxx = "x86_64-w64-mingw32-g++"
        cc = "x86_64-w64-mingw32-gcc"
elif platform.startswith("linux"):
    cxx = "g++"
    cc = "gcc"
elif platform.startswith("mac"):
    cxx = "o64-clang++"
    cc = "o64-clang"
else:
    print(f"Unsupported target platform: {platform}")
    Exit(1)

print(f"Host: {host_platform}, Target: {platform}, Using compiler: {cxx}")

env = Environment(tools=["default"])
env["CXX"] = cxx
env["CC"] = cc
env["ENV"]["PATH"] = os.environ["PATH"]
env["ENV"]["PWD"] = os.getcwd()

if platform.startswith("win"):
    env = Environment(tools=["mingw"])
    mingw_bin_path = os.environ.get("MINGW_BIN", "C:/msys64/ucrt64/bin")
    output_dir = "bin/windows"
    os.makedirs(output_dir, exist_ok=True)

    lib_suffix = "windows.template_debug.x86_64" if build_type == "debug" else "windows.template_release.x86_64"
    env["SHLIBSUFFIX"] = ".dll"

    env.Append(CPPPATH=[
        f"{godot_cpp_path}/include",
        f"{godot_cpp_path}/include/godot_cpp",
        f"{godot_cpp_path}/gen/include",
        f"{godot_cpp_path}/gdextension",
        f"{libuiohook_path}/include",
        "src"
    ])

    env.Append(LIBPATH=[
        f"{godot_cpp_path}/bin",
        f"{libuiohook_path}/lib"
    ])

    env.Append(LIBS=[
        f"godot-cpp.{lib_suffix}",
        "uiohook",
        "user32",
        "winpthread"
    ])

    env.Append(CXXFLAGS=["-std=c++17", "-O2", "-fPIC"])
    env.Append(CPPDEFINES=["NOMINMAX"])
    env.Append(LINKFLAGS=["-shared"])

    required_dlls = ["libstdc++-6.dll", "libgcc_s_seh-1.dll", "libwinpthread-1.dll"]
    for dll in required_dlls:
        src_path = os.path.join(mingw_bin_path, dll)
        dst_path = os.path.join(output_dir, dll)
        if os.path.isfile(src_path):
            env.Execute(Copy(dst_path, src_path))

    libuiohook_src = os.path.join(fixpath(libuiohook_path), "lib", "libuiohook.dll")
    libuiohook_dst = os.path.join(output_dir, "libuiohook.dll")
    env.Command(target=libuiohook_dst, source=libuiohook_src, action=Copy("$TARGET", "$SOURCE"))

elif platform.startswith("linux"):
    output_dir = "bin/linux"
    os.makedirs(output_dir, exist_ok=True)

    lib_suffix = "linux.template_debug.x86_64" if build_type == "debug" else "linux.template_release.x86_64"

    env.Append(CPPPATH=[
        f"{fixpath(godot_cpp_path)}/include",
        f"{fixpath(godot_cpp_path)}/include/godot_cpp",
        f"{fixpath(godot_cpp_path)}/gen/include",
        f"{fixpath(godot_cpp_path)}/gdextension",
        f"{fixpath(libuiohook_path_linux)}/include",
        "src"
    ])

    env.Append(LIBPATH=[
        f"{fixpath(godot_cpp_path)}/bin",
        f"{fixpath(libuiohook_path_linux)}/lib",
        "/usr/lib/x86_64-linux-gnu"
    ])

    env.Append(LIBS=[
        f"godot-cpp.{lib_suffix}",
        "uiohook",
        "pthread"
    ])

    env.Append(LINKFLAGS=[
        "-Wl,-rpath,/usr/lib/x86_64-linux-gnu",
        "-Wl,-rpath,'$ORIGIN'"
    ])

    env.Append(CXXFLAGS=["-std=c++17", "-O2", "-fPIC"])

    libuiohook_src = os.path.join(fixpath(libuiohook_path_linux), "lib", "libuiohook.so")
    libuiohook_dst = os.path.join(output_dir, "libuiohook.so")
    env.Command(target=libuiohook_dst, source=libuiohook_src, action=Copy("$TARGET", "$SOURCE"))

elif platform.startswith("mac"):
    output_dir = "bin/macos"
    os.makedirs(output_dir, exist_ok=True)

    lib_suffix = "macos.template_debug.x86_64" if build_type == "debug" else "macos.template_release.x86_64"

    env["SHLIBSUFFIX"] = ".dylib"

    env.Append(CPPPATH=[
        f"{fixpath(godot_cpp_path)}/include",
        f"{fixpath(godot_cpp_path)}/include/godot_cpp",
        f"{fixpath(godot_cpp_path)}/gen/include",
        f"{fixpath(godot_cpp_path)}/gdextension",
        f"{fixpath(libuiohook_path_macos)}/include",
        "src"
    ])

    env.Append(LIBPATH=[
        f"{fixpath(godot_cpp_path)}/bin",
        f"{fixpath(libuiohook_path_macos)}/lib"
    ])

    env.Append(LIBS=[
        f"godot-cpp.{lib_suffix}",
        "uiohook"
    ])

    env.Append(CXXFLAGS=["-std=c++17", "-O2", "-fPIC"])
    env.Append(LINKFLAGS=["-shared", "-framework", "CoreFoundation", "-framework", "ApplicationServices"])

    libuiohook_src = os.path.join(fixpath(libuiohook_path_macos), "lib", "libuiohook.dylib")
    libuiohook_dst = os.path.join(output_dir, "libuiohook.dylib")
    env.Command(target=libuiohook_dst, source=libuiohook_src, action=Copy("$TARGET", "$SOURCE"))

target_name = (
    f"bin/windows/GlobalInput.{lib_suffix}.dll" if platform.startswith("win")
    else f"bin/linux/GlobalInput.{lib_suffix}.so" if platform.startswith("linux")
    else f"bin/macos/GlobalInput.{lib_suffix}.dylib"
)

env.SharedLibrary(target=target_name, source=sources)
